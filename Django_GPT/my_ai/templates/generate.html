

{% extends "base.html" %}

{% block title %}Translation{% endblock %}

{% block content %}

<div class="chat-wrapper">
    <div id="chat-container" class="chat-container">
        {% if user.is_authenticated %}
            {% for message in messages %}
                <div class="message {{ message.role }}">
                    {{ message.content }}
                </div>
            {% endfor %}
        {% endif %}
    </div>


    <form id="generate-form" class="input-container">
        <textarea name="message" rows="2" placeholder="문장을 입력하세요"></textarea>
        <button type="submit">전송</button>
    </form>
</div>

<script>
    const form = document.getElementById("generate-form");
    const chatContainer = document.getElementById("chat-container");

    function appendMessage(text, sender, isLoading = false) {
        const div = document.createElement("div");
        div.className = `message ${sender} ${isLoading ? 'loading' : ''}`;
        div.innerText = text;
        div.id = isLoading ? 'loading-message' : '';
        chatContainer.appendChild(div);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    form.addEventListener("submit", async function(e) {
        e.preventDefault();
        const text = this.message.value.trim();
        if (!text) return;

        appendMessage(text, "user");
        this.message.value = "";
        
        // 로딩 메시지 표시
        appendMessage("처리 중…", "ai", true);
        const submitButton = this.querySelector("button");
        submitButton.disabled = true;

        try {
            const res = await fetch("/api/generate/", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ message: text })
            });

            const data = await res.json();
            
            // 로딩 메시지 제거
            const loadingMsg = document.getElementById('loading-message');
            if (loadingMsg) loadingMsg.remove();
            
            if (!res.ok) {
                // 에러 응답 처리
                const errorMsg = data.error || "요청 처리 중 오류가 발생했습니다.";
                appendMessage(`❌ 오류: ${errorMsg}`, "ai");
            } else {
                appendMessage(data.reply, "ai");
            }
        } catch (error) {
            // 네트워크 에러 처리
            const loadingMsg = document.getElementById('loading-message');
            if (loadingMsg) loadingMsg.remove();
            appendMessage(`❌ 네트워크 오류: ${error.message}`, "ai");
        } finally {
            submitButton.disabled = false;
        }
    });
</script>

{% endblock %}
