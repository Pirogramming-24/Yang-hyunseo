{% extends "base.html" %}
{% load static %}

{% block title %}Home{% endblock %}

{% block content %}

<div class="page-wrapper">
  <h1 class="page-title">ğŸ“¸ í”¼ë“œ</h1>

  <!-- ìŠ¤í† ë¦¬ ì„¹ì…˜ -->
  <div class="story-section">
    <!-- ë‚´ ìŠ¤í† ë¦¬ (+ ë²„íŠ¼) -->
    <div class="my-story">
      <div id="my-story-btn" class="my-story-button" onclick="openStoryUpload()">â•</div>
      <input type="file" id="story-file-input" accept="image/*" class="hidden-file-input">
    </div>

    <!-- ë‹¤ë¥¸ ì‚¬ìš©ìë“¤ ìŠ¤í† ë¦¬ -->
    <div id="stories-container" class="stories-container"></div>
  </div>

  {% if posts %}
    {% for post in posts %}
      <div class="post-card">
        <!-- í—¤ë”: ì‚¬ìš©ì id -->
        <div class="post-header">
          <span class="post-author">{{ post.author.username }}</span>
        </div>

        <!-- ì‚¬ì§„ -->
        <div class="post-image-wrapper">
          <img class="post-image" src="{{ post.image.url }}" alt="Post image">
        </div>

        <!-- ì½˜í…ì¸  -->
        <div class="post-content">
          <p class="post-text">{{ post.content }}</p>

          <!-- ì—…ë¡œë“œ ì‹œê°„ -->
          <div class="post-time">{{ post.created_at|date:"Yë…„ mì›” dì¼ H:i" }}</div>

          <!-- ì¢‹ì•„ìš” ë²„íŠ¼ -->
          <div class="like-section">
            <button
              class="like-btn"
              data-post-id="{{ post.id }}"
              data-is-liked="{% if request.user in post.likes.all %}true{% else %}false{% endif %}"
              onclick="toggleLike({{ post.id }}, this)">
            </button>
            <span class="likes-count">{{ post.likes.count }}</span>
          </div>

          <!-- ëŒ“ê¸€ ì„¹ì…˜ -->
          <div class="comments-section">
            <!-- ëŒ“ê¸€ ëª©ë¡ -->
            <div class="comments-list" data-post-id="{{ post.id }}">
              {% for comment in post.comments.all %}
                <div class="comment-item" data-comment-id="{{ comment.id }}">
                  <div class="comment-row">
                    <div>
                      <span class="comment-author">{{ comment.author.username }}</span>
                      <span class="comment-content">{{ comment.content }}</span>
                    </div>
                    {% if comment.author == request.user %}
                      <button onclick="deleteComment({{ comment.id }})" class="comment-delete-btn">ì‚­ì œ</button>
                    {% endif %}
                  </div>
                  <div class="comment-time">{{ comment.created_at|date:"mì›” dì¼ H:i" }}</div>
                </div>
              {% endfor %}
            </div>

            <!-- ëŒ“ê¸€ ì‘ì„± -->
            {% if request.user.is_authenticated %}
              <form onsubmit="addComment({{ post.id }}, event)" class="comment-form">
                <input type="text" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." class="comment-input" required />
                <button type="submit" class="comment-submit">ë“±ë¡</button>
              </form>
            {% endif %}
          </div>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div class="empty-state">
      <p class="empty-title">ì•„ì§ ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
      <p class="empty-sub">
        <a href="{% url 'instagram:make_post' %}" class="empty-link">ì²« ê²Œì‹œë¬¼ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</a>
      </p>
    </div>
  {% endif %}
</div>

<script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

function updateLikeButtonStyle(button) {
  const isLiked = button.getAttribute('data-is-liked') === 'true';
  
  if (isLiked) {
    button.textContent = 'â¤ï¸ ì¢‹ì•„ìš” ì·¨ì†Œ';
    button.style.backgroundColor = '#ff3b30';
    button.style.color = 'white';
  } else {
    button.textContent = 'ğŸ¤ ì¢‹ì•„ìš”';
    button.style.backgroundColor = '#f0f0f0';
    button.style.color = '#333';
  }
}

function toggleLike(postId, button) {
  const csrftoken = getCookie('csrftoken');
  
  fetch(`/posts/${postId}/like/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrftoken,
      'Content-Type': 'application/json'
    }
  })
  .then(response => response.json())
  .then(data => {
    const likesCountSpan = button.nextElementSibling;
    likesCountSpan.textContent = data.likes_count;
    
    button.setAttribute('data-is-liked', data.is_liked ? 'true' : 'false');
    updateLikeButtonStyle(button);
  })
  .catch(error => console.error('Error:', error));
}

function addComment(postId, event) {
  event.preventDefault();
  
  const form = event.target;
  const input = form.querySelector('input[type="text"]');
  const content = input.value.trim();
  
  if (!content) {
    alert('ëŒ“ê¸€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  const csrftoken = getCookie('csrftoken');
  const formData = new FormData();
  formData.append('content', content);
  
  fetch(`/posts/${postId}/comments/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrftoken
    },
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      const commentsList = document.querySelector(`.comments-list[data-post-id="${postId}"]`);
      const commentHtml = `
        <div class="comment-item" data-comment-id="${data.comment.id}">
          <div class="comment-row">
            <div>
              <span class="comment-author">${data.comment.author}</span>
              <span class="comment-content">${data.comment.content}</span>
            </div>
            <button onclick="deleteComment(${data.comment.id})" class="comment-delete-btn">ì‚­ì œ</button>
          </div>
          <div class="comment-time">${data.comment.created_at}</div>
        </div>
      `;
      commentsList.insertAdjacentHTML('beforeend', commentHtml);
      input.value = '';
    } else {
      alert('ëŒ“ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  })
  .catch(error => console.error('Error:', error));
}

function deleteComment(commentId) {
  if (!confirm('ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
    return;
  }
  
  const csrftoken = getCookie('csrftoken');
  
  fetch(`/comments/${commentId}/delete/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrftoken,
      'Content-Type': 'application/json'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      const commentItem = document.querySelector(`.comment-item[data-comment-id="${commentId}"]`);
      commentItem.remove();
    }
  })
  .catch(error => console.error('Error:', error));
}

document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.like-btn').forEach(button => {
    updateLikeButtonStyle(button);
  });
  
  // ìŠ¤í† ë¦¬ ëª©ë¡ ë¡œë“œ
  loadStories();
});

function openStoryUpload() {
  document.getElementById('story-file-input').click();
}

document.getElementById('story-file-input').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  const formData = new FormData();
  formData.append('image', file);
  
  const csrftoken = getCookie('csrftoken');
  
  fetch('/stories/create/', {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrftoken
    },
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('ìŠ¤í† ë¦¬ê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
      loadStories();
      e.target.value = ''; // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
    }
  })
  .catch(error => console.error('Error:', error));
});

function loadStories() {
  fetch('/stories/list/')
    .then(response => response.json())
    .then(data => {
      const container = document.getElementById('stories-container');
      container.innerHTML = '';
      
      data.users.forEach(user => {
        const storyHtml = `
          <div class="story-item" onclick="viewStory(${user.user_id})">
            <div class="story-avatar">
              <img src="${user.avatar || 'https://via.placeholder.com/70'}" alt="${user.username}">
            </div>
            <p class="story-username">${user.username}</p>
          </div>
        `;
        container.insertAdjacentHTML('beforeend', storyHtml);
      });
    })
    .catch(error => console.error('Error:', error));
}

function viewStory(userId) {
  window.location.href = `/stories/${userId}/`;
}
</script>
{% endblock %}
