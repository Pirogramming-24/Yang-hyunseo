{% extends "base.html" %}
{% load static %}

{% block title %}{{ user.username }}ì˜ í”„ë¡œí•„{% endblock %}

{% block content %}

<div class="profile-page">
  <!-- í”„ë¡œí•„ ì„¹ì…˜ -->
  <div class="profile-card">
    <!-- ì•„ë°”íƒ€ -->
    <div class="profile-avatar-wrap">
      {% if user.profile.avatar %}
        <img src="{{ user.profile.avatar.url }}" alt="avatar" class="profile-avatar-img">
      {% else %}
        <div class="profile-avatar-placeholder">
          ğŸ‘¤
        </div>
      {% endif %}
    </div>

    <!-- ì‚¬ìš©ì ì •ë³´ -->
    <h2 class="profile-username">
      {{ user.username }}
    </h2>

    <p class="profile-displayname">
      {% if user.profile.display_name %}
        {{ user.profile.display_name }}
      {% else %}
        ë‹‰ë„¤ì„ ì—†ìŒ
      {% endif %}
    </p>

    <!-- ìê¸°ì†Œê°œ -->
    {% if user.profile.bio %}
      <p class="profile-bio">
        {{ user.profile.bio }}
      </p>
    {% endif %}

    <!-- í†µê³„ -->
    <div class="profile-stats">
      <div class="profile-stat">
        <p class="profile-stat-label">ê²Œì‹œë¬¼</p>
        <p class="profile-stat-value">{{ posts.count }}</p>
      </div>
      <div class="profile-stat">
        <p class="profile-stat-label">íŒ”ë¡œì›Œ</p>
        <p class="profile-stat-value">{{ user.follower_relations.count }}</p>
      </div>
      <div class="profile-stat">
        <p class="profile-stat-label">íŒ”ë¡œì‰</p>
        <p class="profile-stat-value">{{ user.following_relations.count }}</p>
      </div>
    </div>

    <!-- íŒ”ë¡œìš° ë²„íŠ¼ -->
    <div class="profile-actions">
      <button
        class="follow-btn btn-follow {% if user in request.user.following_relations.all %}is-following{% else %}is-not-following{% endif %}"
        data-user-id="{{ user.id }}"
        onclick="toggleFollow({{ user.id }}, this)"
      >
        {% if user in request.user.following_relations.all %}
          íŒ”ë¡œì‰
        {% else %}
          íŒ”ë¡œìš°
        {% endif %}
      </button>

      <a href="{% url 'instagram:main' %}" class="btn-back">
        ëŒì•„ê°€ê¸°
      </a>
    </div>
  </div>

  <!-- ê²Œì‹œë¬¼ ì„¹ì…˜ -->
  <div>
    <h3 class="posts-section-title">
      {{ user.username }}ì˜ ê²Œì‹œë¬¼
    </h3>

    {% if posts %}
      <div class="posts-list">
        {% for post in posts %}
          <div class="post-card">
            <!-- ì‚¬ì§„ -->
            <div class="post-image-wrap">
              <img src="{{ post.image.url }}" alt="Post image" class="post-image">
            </div>

            <!-- ì½˜í…ì¸  -->
            <div class="post-body">
              <p class="post-content">
                {{ post.content }}
              </p>

              <!-- ì—…ë¡œë“œ ì‹œê°„ -->
              <div class="post-time">
                {{ post.created_at|date:"Yë…„ mì›” dì¼ H:i" }}
              </div>

              <!-- ì¢‹ì•„ìš” ë²„íŠ¼ -->
              <div class="like-row">
                <button
                  class="like-btn"
                  data-post-id="{{ post.id }}"
                  data-is-liked="{% if request.user in post.likes.all %}true{% else %}false{% endif %}"
                  onclick="toggleLike({{ post.id }}, this)"
                >
                </button>
                <span class="like-count">
                  {{ post.likes.count }}
                </span>
              </div>

              <!-- ëŒ“ê¸€ ì„¹ì…˜ -->
              <div class="comments-wrap">
                <div class="comments-list" data-post-id="{{ post.id }}">
                  {% for comment in post.comments.all %}
                    <div class="comment-item" data-comment-id="{{ comment.id }}">
                      <div class="comment-row">
                        <div>
                          <span class="comment-author">{{ comment.author.username }}</span>
                          <span class="comment-content">{{ comment.content }}</span>
                        </div>

                        {% if request.user == comment.author %}
                          <button onclick="deleteComment({{ comment.id }})" class="comment-delete-btn">
                            ì‚­ì œ
                          </button>
                        {% endif %}
                      </div>

                      <div class="comment-time">
                        {{ comment.created_at|date:"Yë…„ mì›” dì¼ H:i" }}
                      </div>
                    </div>
                  {% endfor %}
                </div>

                {% if request.user.is_authenticated %}
                  <form onsubmit="addComment({{ post.id }}, event)" class="comment-form">
                    {% csrf_token %}
                    <input type="text" placeholder="ëŒ“ê¸€ ì¶”ê°€..." class="comment-input">
                    <button type="submit" class="comment-submit-btn">
                      ê²Œì‹œ
                    </button>
                  </form>
                {% endif %}
              </div>

            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="empty-state">
        <p class="empty-state-title">ì•„ì§ ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
      </div>
    {% endif %}
  </div>
</div>

<script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

function updateLikeButtonStyle(button) {
  const isLiked = button.getAttribute('data-is-liked') === 'true';

  if (isLiked) {
    button.textContent = 'â¤ï¸ ì¢‹ì•„ìš” ì·¨ì†Œ';
    button.style.backgroundColor = '#ff3b30';
    button.style.color = 'white';
  } else {
    button.textContent = 'ğŸ¤ ì¢‹ì•„ìš”';
    button.style.backgroundColor = '#f0f0f0';
    button.style.color = '#333';
  }
}

function toggleLike(postId, button) {
  const csrftoken = getCookie('csrftoken');

  fetch(`/posts/${postId}/like/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrftoken,
      'Content-Type': 'application/json'
    }
  })
  .then(response => response.json())
  .then(data => {
    const likesCountSpan = button.nextElementSibling;
    likesCountSpan.textContent = data.likes_count;

    button.setAttribute('data-is-liked', data.is_liked ? 'true' : 'false');
    updateLikeButtonStyle(button);
  })
  .catch(error => console.error('Error:', error));
}

function toggleFollow(userId, button) {
  const csrftoken = getCookie('csrftoken');

  fetch(`/users/${userId}/follow/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrftoken,
      'Content-Type': 'application/json'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.is_following) {
      button.textContent = 'íŒ”ë¡œì‰';
      button.classList.remove('is-not-following');
      button.classList.add('is-following');
    } else {
      button.textContent = 'íŒ”ë¡œìš°';
      button.classList.remove('is-following');
      button.classList.add('is-not-following');
    }
  })
  .catch(error => console.error('Error:', error));
}

function addComment(postId, event) {
  event.preventDefault();

  const form = event.target;
  const input = form.querySelector('input[type="text"]');
  const content = input.value.trim();

  if (!content) {
    alert('ëŒ“ê¸€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }

  const csrftoken = getCookie('csrftoken');
  const formData = new FormData();
  formData.append('content', content);

  fetch(`/posts/${postId}/comments/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrftoken
    },
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      const commentsList = document.querySelector(`.comments-list[data-post-id="${postId}"]`);

      const commentHtml = `
        <div class="comment-item" data-comment-id="${data.comment.id}">
          <div class="comment-row">
            <div>
              <span class="comment-author">${data.comment.author}</span>
              <span class="comment-content">${data.comment.content}</span>
            </div>
            <button onclick="deleteComment(${data.comment.id})" class="comment-delete-btn">
              ì‚­ì œ
            </button>
          </div>
          <div class="comment-time">
            ${data.comment.created_at}
          </div>
        </div>
      `;

      commentsList.insertAdjacentHTML('beforeend', commentHtml);
      input.value = '';
    } else {
      alert('ëŒ“ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  })
  .catch(error => console.error('Error:', error));
}

function deleteComment(commentId) {
  if (!confirm('ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
    return;
  }

  const csrftoken = getCookie('csrftoken');

  fetch(`/comments/${commentId}/delete/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrftoken,
      'Content-Type': 'application/json'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      const commentItem = document.querySelector(`.comment-item[data-comment-id="${commentId}"]`);
      commentItem.remove();
    }
  })
  .catch(error => console.error('Error:', error));
}

document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.like-btn').forEach(button => {
    updateLikeButtonStyle(button);
  });
});
</script>

{% endblock %}
