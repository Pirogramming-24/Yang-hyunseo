{% extends "base.html" %}

{% block title %}사용자 검색{% endblock %}

{% block content %}


<div class="user-search-page">
  <h2 class="user-search-title">사용자 검색</h2>

  <!-- 검색 폼 -->
  <form method="get" class="search-form">
    <div class="search-row">
      <input
        type="text"
        name="q"
        placeholder="사용자 아이디 입력"
        value="{{ q }}"
        class="search-input"
      />
      <button type="submit" class="search-btn">
        검색
      </button>
    </div>
  </form>

  <!-- 검색 결과 -->
  {% if q %}
    {% if results %}
      <div>
        <p class="result-summary">
          '{{ q }}'에 대한 검색 결과 ({{ results.count }}명)
        </p>

        <div class="result-list">
          {% for user in results %}
            <div class="user-card">
              <div>
                <p class="user-name">{{ user.username }}</p>
                <p class="user-sub">
                  {% if user.first_name or user.last_name %}
                    {{ user.first_name }} {{ user.last_name }}
                  {% else %}
                    프로필 없음
                  {% endif %}
                </p>
              </div>

              <div class="user-actions">
                <a href="{% url 'instagram:othersprofile' user.id %}" class="btn-profile">
                  프로필
                </a>

                {% if user.id != request.user.id %}
                  <button
                    class="follow-btn btn-follow {% if user in request.user.following_relations.all %}is-following{% else %}is-not-following{% endif %}"
                    data-user-id="{{ user.id }}"
                    onclick="toggleFollow({{ user.id }}, this)"
                  >
                    {% if user in request.user.following_relations.all %}
                      팔로잉
                    {% else %}
                      팔로우
                    {% endif %}
                  </button>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% else %}
      <div class="empty-state">
        <p class="empty-state-text">
          '{{ q }}'에 해당하는 사용자를 찾을 수 없습니다.
        </p>
      </div>
    {% endif %}
  {% else %}
    <div class="empty-state">
      <p class="empty-state-text">
        위의 검색창에서 사용자 아이디를 입력해 검색해주세요.
      </p>
    </div>
  {% endif %}
</div>

<script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

function toggleFollow(userId, button) {
  const csrftoken = getCookie('csrftoken');

  fetch(`/users/${userId}/follow/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrftoken,
      'Content-Type': 'application/json'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.is_following) {
      button.textContent = '팔로잉';
      button.classList.remove('is-not-following');
      button.classList.add('is-following');
    } else {
      button.textContent = '팔로우';
      button.classList.remove('is-following');
      button.classList.add('is-not-following');
    }
  })
  .catch(error => console.error('Error:', error));
}
</script>

{% endblock %}
