{% extends "base.html" %}
{% load static %}

{% block title %}{{ target_user.username }}ì˜ ìŠ¤í† ë¦¬{% endblock %}

{% block content %}

<div class="story-page">
  <!-- í—¤ë” -->
  <div class="story-header">
    <div class="story-header-left">
      {% if target_user.profile.avatar %}
        <img src="{{ target_user.profile.avatar.url }}" alt="avatar" class="story-avatar-img">
      {% else %}
        <div class="story-avatar-placeholder">ğŸ‘¤</div>
      {% endif %}

      <div class="story-user-meta">
        <p class="story-username">{{ target_user.username }}</p>
        <p class="story-time">
          {% if stories %}{{ stories.0.created_at|date:"H:i" }}{% endif %}
        </p>
      </div>
    </div>

    <a href="{% url 'instagram:main' %}" class="story-close">âœ•</a>
  </div>

  <!-- ìŠ¤í† ë¦¬ ì½˜í…ì¸  -->
  <div class="story-content">
    {% if stories %}
      <div id="story-viewer" class="story-viewer">
        {% for story in stories %}
          <div class="story-frame" data-story-id="{{ story.id }}">
            {% for item in story.items.all %}
              <img src="{{ item.image.url }}" alt="Story" class="story-image">
            {% endfor %}
          </div>
        {% endfor %}
      </div>

      <!-- ì§„í–‰ë¥  ë°” -->
      <div class="story-progress">
        {% for story in stories %}
          <div class="progress-bar" data-story-id="{{ story.id }}"></div>
        {% endfor %}
      </div>

      <!-- ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ -->
      <button onclick="previousStory()" class="story-nav-btn story-nav-prev">
        â€¹
      </button>

      <button onclick="nextStory()" class="story-nav-btn story-nav-next">
        â€º
      </button>
    {% else %}
      <div class="story-empty">
        <p class="story-empty-title">ìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        <a href="{% url 'instagram:main' %}" class="story-empty-link">
          ëŒì•„ê°€ê¸°
        </a>
      </div>
    {% endif %}
  </div>
</div>

<script>
let currentStoryIndex = 0;
const totalStories = {{ stories.count }};

function showStory(index) {
  const frames = document.querySelectorAll('.story-frame');
  const bars = document.querySelectorAll('.progress-bar');

  // ì´ˆê¸°í™”
  frames.forEach(frame => frame.style.display = 'none');
  bars.forEach(bar => bar.classList.remove('is-active'));

  // í˜„ì¬ í‘œì‹œ
  if (frames[index]) {
    frames[index].style.display = 'block';
    if (bars[index]) bars[index].classList.add('is-active');
    currentStoryIndex = index;
  }
}

function nextStory() {
  if (currentStoryIndex < totalStories - 1) {
    showStory(currentStoryIndex + 1);
  }
}

function previousStory() {
  if (currentStoryIndex > 0) {
    showStory(currentStoryIndex - 1);
  }
}

document.addEventListener('DOMContentLoaded', function() {
  if (totalStories > 0) showStory(0);

  // í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜
  document.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowRight') nextStory();
    if (e.key === 'ArrowLeft') previousStory();
  });
});
</script>

{% endblock %}
